"""
EcoCampus AI - 校园节能指挥官
Flask 应用入口
"""
import os
import random

import requests
from flask import Flask, render_template, request, jsonify

from model import EnergyPredictor

app = Flask(__name__)
predictor = EnergyPredictor()

# 本地备用：无 DeepSeek Key 时随机返回的环保评价（丰富版）
REPORT_PRESETS = [
    "本周你在节能知识闯关中表现不错！坚持从小事做起，关灯、节水、垃圾分类，都是对地球的贡献。继续加油，环保值会越来越高！",
    "你的环保意识正在提升！每一点节约都会汇聚成巨大的能量。建议下周多尝试「光照调节」：白天多用自然光，既护眼又省电。",
    "感谢你参与校园节能行动！你的选择正在减少碳排放。下一周可以挑战：空调设定在 26℃、随手关灯、电池送到回收点，一起做地球的守护者。",
    "本周节能周报：你的环保值体现了你对绿色生活的重视。AI 分析：养成随手关灯、合理设定空调的习惯，长期下来能显著降低校园能耗。",
    "太棒了！你在闯关中的表现说明你已掌握基础节能知识。继续保持，并把知识用到日常：回收电池、节约用水用电，你就是校园里的环保小达人。",
    "校园节能离不开每一个人的参与。你的每一次正确选择，都在为绿色校园加分。下周记得：离开教室关灯、电脑不用时休眠，小小举动大大能量。",
    "环保不是一天的事，而是每一天的事。本周的闯关表现已经证明你在进步，把学到的知识带到宿舍、食堂、教室，你就是行走的节能宣传员。",
    "节能周报提醒：夏天空调每调高 1℃，约可省电 7%。把 26℃ 设为习惯，既舒适又低碳。电池、灯管记得投放到指定回收点哦。",
    "你的节能选择正在产生真实影响。据估算，校园若普遍采用自然光+分区照明，年用电可降一成以上。继续做那个关灯、关空调的人吧！",
    "本周小结：知识闯关是起点，日常行动才是终点。建议在书桌旁贴一张「离开即关灯」的小便签，让节能成为条件反射。",
    "绿色校园需要你这样的行动派。废旧电池、废灯管别乱丢，送到回收点是对土壤和水源的保护。下周可以试试记录一周关灯次数，看看自己的进步。",
    "AI 分析：合理利用自然光不仅能省电，还能减少眼睛疲劳。白天靠窗的座位尽量关掉头顶灯，既环保又护眼，一举两得。",
    "环保值是对你绿色行为的认可。坚持 26℃ 空调、随手关灯、垃圾分类，这些习惯会伴随你走出校园，影响更多人。",
    "每节约一度电，就少一份燃煤排放。你的每一个小习惯，都在为碳中和做贡献。本周继续保持，下周我们再看你的周报！",
    "节能小贴士：教室无人时记得关灯关空调；充电器不用时拔掉；打印前先预览，减少废纸。把这些变成习惯，你就是满分环保达人。",
    "你的参与让校园更绿一点。电池回收、光照调节、空调设定——闯关里的每一题都在对应真实场景。把答案变成行动，效果会超乎想象。",
    "本周节能周报：坚持正确回收电池，可以避免重金属污染土壤与地下水。你的选择不仅省资源，更在保护我们共同的环境。",
    "白天采光好的时候，关掉靠窗一侧的灯，既省电又不影响看书。这个小技巧很多同学都在用，你也可以从明天开始试试。",
    "空调 26℃ 是舒适与节能的黄金温度。养成习惯后，你会发现电费更省、身体也更适应，不会一进一出就感冒。",
    "感谢你为校园节能付出的每一分努力。环保没有旁观者，每个人都是参与者。下周继续闯关、继续实践，我们一起把绿色进行到底。",
    "你的节能知识正在转化为行动力。记住：关灯、关空调、回收电池，这三件事做好，就已经超过很多人了。继续保持！",
    "本周鼓励语：绿色生活不是牺牲，而是更聪明的选择。省下的电、分好的类，都在让我们的校园和地球更健康。",
    "小行动，大改变。你今天的每一个节能选择，都会在未来汇聚成可观的减排量。加油，环保值会见证你的成长。",
    "节能周报：离开教室前花 3 秒检查一下灯和空调，就能避免一整天的浪费。养成这个 3 秒习惯，你会成为班级里的节能榜样。",
    "你的环保意识已经走在很多人前面。把闯关里学到的「电池回收」「光照调节」「空调设定」带到生活中，你就是真正的校园节能指挥官。",
]

# 节能助手：纯规则匹配，无需任何 API Key，完全本地。大量回复以假乱真。
# 顺序重要：问候/感谢优先，再具体话题，最后通用。关灯不含「省电」；电池在单字「灯」前。
CHAT_REPLIES = [
    # ---------- 问候 / 帮助（优先）----------
    (
        ["你好", "嗨", "在吗", "哈喽", "hello", "hi", "帮助", "怎么用", "有什么功能", "能做什么", "你是谁", "干嘛的"],
        [
            "你好呀～我是 EcoCampus 的节能小助手，有啥想聊的都可以问！比如空调怎么省电、关灯有啥好处、电池咋回收，或者去玩玩「知识闯关」「我的周报」都行～",
            "嗨！我是校园节能助手，专门答节能、环保、省电相关的问题。想问啥直接说，也可以去首页试试智能预测、闯关和周报～",
            "在呢在呢～可以问我空调、关灯、回收、闯关、周报啥的，或者聊聊怎么省电、怎么更环保，我都行！",
            "你好～这里啥都能问：能耗预测怎么玩、闯关在哪、周报咋生成、空调几度省电、电池往哪扔…你随便起个头我就接！",
            "哈喽！我是节能小助手，不收费不用注册，想问就问。空调 26℃、关灯、电池回收、走楼梯、双面打印…这些我都熟～",
        ],
    ),
    # ---------- 感谢（优先）----------
    (
        ["谢谢", "感谢", "多谢", "谢了", "thanks", "thx"],
        [
            "不客气～有问题随时再来问，一起为绿色校园加油！",
            "不用谢！多做点小行动，你就是校园节能指挥官～",
            "客气啥～有想问的继续发就行！",
            "没事儿～能帮上忙就好，记得关灯关空调哦～",
        ],
    ),
    # ---------- 再见 / 结束 ----------
    (
        ["再见", "拜拜", "bye", "走了", "下次聊", "先这样", "没了"],
        [
            "拜拜～记得人走关灯关空调，下次见！",
            "再见！有问题随时回来找我～",
            "好的，下次再聊～随手关灯关空调哦！",
        ],
    ),
    # ---------- 空调 / 温度 ----------
    (
        ["空调", "温度", "26", "制冷", "暖气", "开空调", "调温", "几度", "冷气", "热风", "空调费电", "省电空调"],
        [
            "空调设定 26℃ 最省电又舒服，每调高 1℃ 大概能省 7% 电。夏天试试 26℃，凉快又环保～",
            "推荐 26℃：舒适和节能的黄金温度，很多同学养成习惯后电费真的会下来。",
            "夏天空调每调高 1℃ 大约省电 7%，26℃ 对大多数人已经够凉了，记得走的时候关掉哦。",
            "26℃ 是公认的省电又体感好的温度，别开太低，离开教室、宿舍记得关，不然白烧一整天。",
            "空调这块就记住两点：26℃ + 人走就关。长期下来省不少，对身体也好，不会一进一出感冒。",
            "制冷别往 22、23 度打，26℃ 足够，省电又减少温差。暖气也是，别开太高，够暖就行。",
        ],
    ),
    # ---------- 关灯 / 照明 ----------
    (
        ["关灯", "开灯", "照明", "自然光", "采光", "人走灯灭", "忘关灯", "灯没关"],
        [
            "白天采光好的时候关掉靠窗的灯，用自然光既省电又护眼。离开教室、自习室记得关灯，人走灯灭。",
            "自然光够用就少开灯，靠窗座位可以把头顶灯关掉试试，很多同学都这么干。",
            "离开前花几秒看一眼灯和空调，关掉再走，能避免一整天的浪费，养成习惯你就是节能小能手。",
            "教室、图书馆、宿舍离开时顺手关灯，一个人省一点，全校加起来就很多。",
            "白天尽量用自然光，晚上用哪开哪、人走即关，别让空教室亮一宿。",
        ],
    ),
    # ---------- 电池 / 回收（在单字「灯」前）----------
    (
        ["电池", "回收", "废旧", "有害垃圾", "灯管", "废电池", "旧电池", "纽扣电池", "扔电池"],
        [
            "废旧电池、废灯管要投到有害垃圾或指定回收点，别乱丢，避免重金属污染土壤和水源。",
            "电池回收很重要！乱丢会污染环境，记得投「有害垃圾」或校园里的回收点。",
            "电池、灯管属于有害垃圾，别混在普通垃圾里。找到回收箱或回收点投进去，就是在保护环境。",
            "纽扣电池、充电电池、灯管都算有害垃圾，学校一般有回收点，问一下宿管或物业就知道。",
            "废电池别扔普通垃圾桶，有害垃圾箱或回收点才是归宿，举手之劳就能减少污染。",
        ],
    ),
    # ---------- 单字「灯」（在电池/灯管之后）----------
    (
        ["灯"],
        [
            "白天能自然光就少开灯，离开时记得关灯，人走灯灭，省电又环保。",
            "灯这块就记住：用就开、走就关，白天尽量借自然光。",
            "开灯用、走关灯，白天多用自然光，简单好记～",
        ],
    ),
    # ---------- 能耗 / 预测 / 仪表盘 ----------
    (
        ["预测", "能耗", "用电", "用电量", "功率", "千瓦", "智能预测", "仪表盘", "滑块", "模拟", "情景预设"],
        [
            "在「智能监控区」用时间、温度、是否节假日三个滑块可以实时预测校园能耗，下面还有仪表盘和最近预测记录，挺直观的。",
            "首页智能监控区能模拟不同情景的能耗，试试「工作日」「夏夜」「节假日」预设，看仪表盘数字变化就懂了。",
            "想玩预测的话，去智能监控区调那三个滑块就行，系统会算当前情景下的能耗，下面还有最近几次预测记录。",
            "仪表盘和滑块都在智能监控区，改时间、温度、节假日，预测功率会跟着变，还能一键用情景预设。",
        ],
    ),
    # ---------- 闯关 / 答题 ----------
    (
        ["闯关", "答题", "题目", "挑战", "环保值", "得分", "知识闯关", "十关", "10关"],
        [
            "去页面的「知识闯关」可以玩 10 关节能题，答对加环保值还有小贴士，挺有意思的。",
            "节能知识闯关在首页就有，10 道题涵盖关灯、空调、回收啥的，闯完还能生成周报。",
            "试试「知识闯关」～题目都是日常节能场景，答完还能生成你的节能周报，一举两得。",
            "首页往下拉找到知识闯关，一共 10 关，答完能看到解析，还能根据得分生成周报评语。",
        ],
    ),
    # ---------- 周报 ----------
    (
        ["周报", "报告", "评语", "总结", "节能周报", "生成周报"],
        [
            "在「我的节能周报」里点「生成我的节能周报」，会根据你闯关得分给一段鼓励评语，先玩闯关再生成更有针对性。",
            "完成知识闯关后，到周报区块一键生成，会有专属评语和行动建议。",
            "周报在首页往下拉就有，先玩完闯关再点生成，评语会结合你的得分来。",
        ],
    ),
    # ---------- 成就 / 徽章 ----------
    (
        ["成就", "徽章", "勋章", "解锁", "收集"],
        [
            "「成就徽章」区在首页往下拉，有首次预测、闯关达人、满分、周报生成等，做完对应的事就会解锁。",
            "成就徽章做完预测、闯关、周报这些任务会逐步解锁，集齐还挺有成就感的。",
        ],
    ),
    # ---------- 贴士 / 技巧 ----------
    (
        ["贴士", "小贴士", "技巧", "建议", "妙招", "有啥招"],
        [
            "首页有「节能贴士」区块，标题下面还有小贴士轮播，都是日常省电省资源的小技巧。",
            "节能贴士网格和顶部轮播里都有，空调 26℃、关灯、回收电池、走楼梯这些都会提到。",
        ],
    ),
    # ---------- 垃圾分类 ----------
    (
        ["垃圾", "分类", "可回收", "厨余", "干垃圾", "湿垃圾", "扔垃圾", "垃圾桶", "怎么扔"],
        [
            "垃圾分类记得：可回收（纸、塑料瓶、金属）、有害（电池、灯管）、厨余、其他。电池灯管别混进普通垃圾。",
            "塑料瓶、易拉罐、废纸是可回收；电池、灯管是有害；果皮饭菜是厨余。分对了就是在帮大忙。",
            "可回收、有害、厨余、其他四类，电池灯管一定走有害，别乱丢。",
        ],
    ),
    # ---------- 用水 ----------
    (
        ["水", "用水", "节水", "水龙头", "浪费水", "节约用水", "省水"],
        [
            "用水方面：随手关紧水龙头，洗漱别一直开着流，洗东西用盆接水能省不少。",
            "节水小习惯：关紧龙头、用多少接多少、洗澡别冲太久，宿舍楼一起省效果很明显。",
            "龙头用完就关紧，别长流水，洗衣服洗菜能接盆就接盆，省水又省心。",
        ],
    ),
    # ---------- 出行 / 交通 ----------
    (
        ["出行", "交通", "骑车", "步行", "公交", "低碳出行", "走路", "骑行"],
        [
            "短距离优先步行或骑车，零排放又锻炼身体；远一点坐公交地铁，比打车省资源。",
            "校园里一两公里走走路、骑骑车就挺好，低碳又健康。",
            "能走路骑车就不打车，既省又环保，还锻炼身体。",
        ],
    ),
    # ---------- 打印 / 纸张 ----------
    (
        ["打印", "纸张", "双面", "复印", "打印店", "废纸"],
        [
            "打印前先预览，减少打错；能双面就双面，省纸又环保。",
            "双面打印、先预览再打，省纸又省树，小习惯大不同。",
        ],
    ),
    # ---------- 楼梯 / 电梯 ----------
    (
        ["楼梯", "电梯", "爬楼", "楼层", "走楼梯"],
        [
            "1～3 层建议走楼梯，省电梯电又锻炼身体，一举两得。",
            "低楼层走楼梯是个好习惯，既省电又健康，明天就可以试试。",
        ],
    ),
    # ---------- 充电 / 待机 / 电器 ----------
    (
        ["充电", "待机", "充电器", "插头", "关机", "休眠", "待机能耗", "电脑", "手机", "拔插头"],
        [
            "充电器不用时拔掉，待机也会耗电。电脑不用就关机或休眠，能省不少。",
            "手机充满就拔充电器，电脑不用就休眠或关机，这些小细节积少成多。",
            "很多电器待机也在耗电，不用就关掉或拔插头，尤其是充电器、排插上的小电器。",
        ],
    ),
    # ---------- 教室 / 宿舍 / 校园场景 ----------
    (
        ["教室", "宿舍", "食堂", "图书馆", "自习室", "离开"],
        [
            "离开教室、宿舍、自习室前记得关灯关空调，检查一下再走，几秒钟就能避免一天浪费。",
            "不管在教室还是宿舍，人走就关灯关空调，养成习惯整个校园都能省很多。",
        ],
    ),
    # ---------- 冬天 / 夏天 ----------
    (
        ["冬天", "夏天", "冬季", "夏季", "冷", "热"],
        [
            "夏天空调 26℃、人走就关；冬天暖气别开太高，够暖就行。出门前关掉，回来再开。",
            "冬夏都是用电高峰，空调暖气别开过头，人走关掉，能省一大截。",
        ],
    ),
    # ---------- 为什么 / 有用吗 / 真的吗 ----------
    (
        ["为什么", "有用吗", "真的吗", "有用", "效果", "意义", "有啥用"],
        [
            "节能看起来是小事，但每个人省一点，全校、全社会加起来就很多，而且能减少碳排放，对气候也有帮助。",
            "真的有用。养成关灯、26℃ 空调、回收这些习惯，电费会下来，环境也会更好，一举两得。",
        ],
    ),
    # ---------- 随便聊 / 不知道问啥 ----------
    (
        ["随便", "不知道", "没啥", "想不出", "推荐", "第一次", "新手"],
        [
            "没事儿～你可以试试问我：空调开几度省电？灯管往哪扔？或者去首页玩玩「知识闯关」「智能预测」「我的周报」，都挺有意思的。",
            "随便问就行～比如「怎么省电」「电池怎么回收」「闯关在哪」，或者先去玩一把闯关、生成一次周报，再来问我都成。",
        ],
    ),
    # ---------- 节能 / 环保 / 省电 通用（放最后）----------
    (
        ["节能", "环保", "低碳", "减排", "碳中和", "绿色", "节约", "省电", "怎么省", "如何省"],
        [
            "节能从小事做起：关灯、26℃ 空调、回收电池、双面打印、走楼梯…每一点都在为地球加分。",
            "绿色校园需要每一个人。关灯、关空调、垃圾分类，这些小习惯都在产生真实影响。",
            "小行动大改变。今天就可以开始：离开关灯、空调 26℃、电池送回收点～",
            "省电省资源不用搞很大，日常这几件做好就够：关灯、空调别太低、充电器不用就拔、能走楼梯就走。",
        ],
    ),
]

# 默认回复（无匹配时随机一条，以假乱真）
CHAT_FALLBACKS = [
    "你可以问我：空调怎么省电？关灯有什么好处？电池怎么回收？能耗怎么预测？也可以去试试「知识闯关」和「我的周报」～",
    "想问啥都可以～比如「空调几度省电」「灯管往哪扔」「闯关在哪」「周报怎么生成」，或者直接说你想了解的。",
    "试试问我：空调、关灯、电池回收、能耗预测、闯关、周报、成就徽章…随便起个头我就接！",
]
CHAT_EMPTY = "发一句话给我吧～比如「空调怎么省电」或「电池怎么回收」～"
MAX_CHAT_MESSAGE_LENGTH = 500


def _chat_reply(user_text: str) -> str:
    """根据用户输入做关键词匹配，返回一条预设回复，无需任何 API。"""
    if not isinstance(user_text, str):
        return random.choice(CHAT_FALLBACKS)
    t = user_text.strip()
    if not t:
        return CHAT_EMPTY
    if len(t) > MAX_CHAT_MESSAGE_LENGTH:
        t = t[:MAX_CHAT_MESSAGE_LENGTH]
    t_lower = t.lower()
    for keywords, replies in CHAT_REPLIES:
        if any(kw in t_lower for kw in keywords):
            return random.choice(replies)
    return random.choice(CHAT_FALLBACKS)


@app.route("/")
def index():
    """首页"""
    return render_template("index.html")


@app.route("/api/predict", methods=["POST"])
def api_predict():
    """
    能耗预测 API。
    请求体 JSON: { "hour": number, "temp": number, "is_holiday": 0|1 }
    返回 JSON: { "power": number } 或错误信息。
    """
    try:
        data = request.get_json(force=True, silent=True) or {}
        hour = float(data.get("hour", 12))
        temp = float(data.get("temp", 20))
        is_holiday = int(data.get("is_holiday", 0))
        if not 0 <= hour <= 24:
            return jsonify({"error": "hour 需在 0-24 之间"}), 400
        if not 0 <= is_holiday <= 1:
            return jsonify({"error": "is_holiday 需为 0 或 1"}), 400
        power = predictor.predict(hour, temp, is_holiday)
        return jsonify({"power": round(power, 2)})
    except (TypeError, ValueError) as e:
        return jsonify({"error": f"参数错误: {e}"}), 400


def _generate_report_with_deepseek(score: int) -> str | None:
    """若有 DEEPSEEK_API_KEY 则调用 DeepSeek 生成鼓励语，否则返回 None。"""
    api_key = os.environ.get("DEEPSEEK_API_KEY", "").strip()
    if not api_key:
        return None
    try:
        url = "https://api.deepseek.com/v1/chat/completions"
        headers = {
            "Authorization": f"Bearer {api_key}",
            "Content-Type": "application/json",
        }
        payload = {
            "model": "deepseek-chat",
            "messages": [
                {
                    "role": "system",
                    "content": (
                        "你是一名「EcoCampus 首席节能官」，说话风格幽默、富有激情。"
                        "请根据用户的得分（满分 100 分），生成一份像游戏战报一样的简短评语，多用 Emoji，"
                        "最后必须给出一个具体的行动指令（比如「明天试试走楼梯！」）。"
                        "不要用 markdown，纯文本即可。"
                    ),
                },
                {
                    "role": "user",
                    "content": f"用户本周节能闯关得分为 {score} 分（满分 100）。请生成战报式评语并给出一个具体行动指令。",
                },
            ],
            "max_tokens": 256,
        }
        resp = requests.post(url, headers=headers, json=payload, timeout=15)
        resp.raise_for_status()
        data = resp.json()
        choices = data.get("choices")
        if not choices:
            return None
        message = choices[0].get("message") or {}
        text = message.get("content", "")
        return (text or "").strip() or None
    except Exception:
        return None


@app.route("/api/report", methods=["POST"])
def api_report():
    """
    生成节能周报鼓励语。
    请求体 JSON 可选: { "score": number }，默认 0。
    若有 DEEPSEEK_API_KEY 则调用 DeepSeek；否则返回随机预设环保评价。
    """
    try:
        data = request.get_json(force=True, silent=True) or {}
        score = int(data.get("score", 0))
        score = max(0, min(100, score))
    except (TypeError, ValueError):
        score = 0

    # 有 DeepSeek Key 则调用 AI；否则无缝切换到本地预设（10+ 条随机）
    text = _generate_report_with_deepseek(score)
    if not text:
        text = random.choice(REPORT_PRESETS)
    return jsonify({"report": text, "score": score})


@app.route("/api/chat", methods=["POST"])
def api_chat():
    """
    节能助手对话。纯规则匹配，无需 API Key。
    请求体 JSON: { "message": "用户输入" }
    返回 JSON: { "reply": "助手回复" }
    """
    try:
        data = request.get_json(force=True, silent=True) or {}
        message = data.get("message", "")
        if not isinstance(message, str):
            message = ""
        reply = _chat_reply(message)
        return jsonify({"reply": reply})
    except Exception:
        return jsonify({"reply": "我这边有点卡，稍后再试一下吧～"})


if __name__ == "__main__":
    # 允许通过 0.0.0.0 访问，方便局域网/云部署；PORT 由云平台注入
    port = int(os.environ.get("PORT", 5000))
    debug = os.environ.get("FLASK_DEBUG", "true").lower() in ("1", "true", "yes")
    app.run(host="0.0.0.0", port=port, debug=debug)
